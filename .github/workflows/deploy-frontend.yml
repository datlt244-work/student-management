name: Deploy Frontend to Self-Hosted Runner

on:
  push:
    branches: [ "main" ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

jobs:
  deploy-frontend:
    runs-on: self-hosted
    # Thêm defaults để không phải lặp lại working-directory
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Chỉ cần setup Node để Lint/Typecheck (nếu muốn). 
      # Nếu không cần lint ở đây (vì đã làm ở local/CI khác) thì có thể bỏ bước này để deploy nhanh hơn.
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9 # Dùng v9 hoặc v10 cho mới

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies (for Linting)
        run: pnpm install --frozen-lockfile

      - name: Lint and type check
        run: |
          pnpm lint
          pnpm type-check

      # TẠO FILE ENV QUAN TRỌNG
      # File này sẽ được Docker COPY vào và dùng để build
      - name: Create .env.production file
        run: |
          if [ -z "${{ secrets.FRONTEND_ENV_FILE }}" ]; then
            echo "❌ ERROR: Secret FRONTEND_ENV_FILE is missing"
            exit 1
          fi
          echo "${{ secrets.FRONTEND_ENV_FILE }}" > .env.production
          echo "✓ .env.production created"

      # --- BỎ BƯỚC pnpm build-only Ở ĐÂY (VÌ DOCKER SẼ LÀM) ---

      - name: Ensure network exists
        # Chạy ở root (ngoài frontend dir) hoặc chỉ định shell
        working-directory: . 
        run: |
          docker network inspect student-management-network >/dev/null 2>&1 || \
          docker network create student-management-network

      - name: Deploy with Docker Compose
        run: |
          # Dọn dẹp container cũ
          docker compose down --remove-orphans
          
          # Build và chạy mới (Build sẽ lấy .env.production vừa tạo ở trên)
          docker compose up -d --build --force-recreate
          
          # Xóa image rác
          docker image prune -f

      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 5
          
          if ! docker ps | grep -q 'student-frontend'; then
            echo "❌ Container failed to start. Logs:"
            docker logs student-frontend
            exit 1
          fi

          echo "✓ Container is running."
          # Optional: Check curl localhost if needed
